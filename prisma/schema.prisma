generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String             @id @default(cuid())
  email                    String             @unique
  passwordHash             String
  name                     String?
  resetPasswordToken       String?            @unique
  resetPasswordTokenExpiry DateTime?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  transactions             Transaction[]
  categories               Category[]
  weeklyCheckins           WeeklyCheckin[]
  balanceSnapshots         BalanceSnapshot[]
  settings                 Settings?
  rateLimits               RateLimit[]

  @@index([email])
}

model Transaction {
  id            String    @id @default(cuid())
  userId        String
  type          String    // 'expense' or 'income'
  amount        Float     // Stored as positive number, type indicates direction
  date          DateTime  // Full date/time of transaction
  categoryId    String?   // Optional category
  merchant      String?   // Where money was spent/received
  paymentMethod String?   // Cash, Card, Transfer, etc.
  notes         String    @default("")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([categoryId])
}

model Category {
  id           String        @id @default(cuid())
  userId       String
  name         String        // "Groceries", "Rent", etc.
  type         String        // 'expense' or 'income'
  parentGroup  String?       // "Essentials", "Lifestyle", "Health", "Personal"
  colorTag     String?       // Hex color for UI (e.g. #57ab5a)
  icon         String?       // Icon identifier (lucide icon name)
  order        Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name, type])
  @@index([userId])
  @@index([type])
  @@index([parentGroup])
}

model WeeklyCheckin {
  id                String   @id @default(cuid())
  userId            String
  weekStartDate     DateTime // Monday of the week
  weekEndDate       DateTime // Sunday of the week
  totalIncome       Float    @default(0) // Income for the week
  totalExpenses     Float    @default(0) // Expenses for the week
  netChange         Float    @default(0) // Income - Expenses
  startingBalance   Float    @default(0) // Balance at start of week
  endingBalance     Float    @default(0) // Balance at end of week
  reflectionNotes   String   @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
}

model BalanceSnapshot {
  id        String   @id @default(cuid())
  userId    String
  balance   Float    // Current balance at this point
  status    String   // 'safe', 'tight', or 'danger'
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
}

model Settings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  theme                 String   @default("dark")
  currency              String   @default("USD")
  safeThreshold         Float?   // Optional: balance above = safe (default 1000)
  tightThreshold        Float?   // Optional: balance above = tight, below = danger (default 200)
  enableWarnings        Boolean  @default(true)
  warningThreshold      Float?   // Optional: show warnings when balance below this
  defaultPaymentMethod  String?  // Default payment method (Cash, Card, Transfer, etc.)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RateLimit {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([resetAt])
}
