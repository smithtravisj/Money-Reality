generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String             @id @default(cuid())
  email                    String             @unique
  passwordHash             String
  name                     String?
  resetPasswordToken       String?            @unique
  resetPasswordTokenExpiry DateTime?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  transactions             Transaction[]
  categories               Category[]
  accounts                 Account[]
  weeklyCheckins           WeeklyCheckin[]
  balanceSnapshots         BalanceSnapshot[]
  settings                 Settings?
  savingsCategories        SavingsCategory[]
  rateLimits               RateLimit[]

  @@index([email])
}

model Account {
  id               String        @id @default(cuid())
  userId           String
  name             String
  type             String        // 'checking', 'savings', 'credit', 'cash'
  currentBalance   Float         @default(0)
  notes            String        @default("")
  colorTag         String?
  icon             String?
  order            Int           @default(0)
  isDefault        Boolean       @default(false)
  autoPayAccountId String?       // FK to another Account (checking/savings) for credit card auto-pay
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
  autoPayAccount     Account?      @relation("AutoPay", fields: [autoPayAccountId], references: [id], onDelete: SetNull)
  linkedCreditCards  Account[]     @relation("AutoPay")

  @@index([userId])
  @@index([type])
  @@index([autoPayAccountId])
  @@unique([userId, name])
}

model Transaction {
  id            String    @id @default(cuid())
  userId        String
  type          String    // 'expense' or 'income'
  amount        Float     // Stored as positive number, type indicates direction
  date          DateTime  // Full date/time of transaction
  accountId     String    // Required - every transaction belongs to an account
  categoryId    String?   // Optional category
  merchant      String?   // Where money was spent/received
  paymentMethod String?   // Cash, Card, Transfer, etc.
  notes         String    @default("")
  allocations   String    @default("[]") // JSON array of allocations to savings categories
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       Account   @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([accountId])
  @@index([categoryId])
}

model Category {
  id           String        @id @default(cuid())
  userId       String
  name         String        // "Groceries", "Rent", etc.
  type         String        // 'expense' or 'income'
  parentGroup  String?       // "Essentials", "Lifestyle", "Health", "Personal"
  colorTag     String?       // Hex color for UI (e.g. #57ab5a)
  icon         String?       // Icon identifier (lucide icon name)
  order        Int           @default(0)
  monthlyBudget Float?       // YNAB-style budget allocation per month (null = no budget set)
  budgetPeriod String        @default("monthly") // Future: support 'weekly', 'yearly'
  rolloverBalance Float      @default(0) // Accumulated unspent budget from previous months
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name, type])
  @@index([userId])
  @@index([type])
  @@index([parentGroup])
}

model WeeklyCheckin {
  id                String   @id @default(cuid())
  userId            String
  weekStartDate     DateTime // Monday of the week
  weekEndDate       DateTime // Sunday of the week
  totalIncome       Float    @default(0) // Income for the week
  totalExpenses     Float    @default(0) // Expenses for the week
  netChange         Float    @default(0) // Income - Expenses
  startingBalance   Float    @default(0) // Balance at start of week
  endingBalance     Float    @default(0) // Balance at end of week
  reflectionNotes   String   @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
}

model BalanceSnapshot {
  id        String   @id @default(cuid())
  userId    String
  balance   Float    // Current balance at this point
  status    String   // 'safe', 'tight', or 'danger'
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
}

model Settings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  theme                 String   @default("dark")
  currency              String   @default("USD")
  safeThreshold         Float?   // Optional: balance above = safe (default 1000)
  tightThreshold        Float?   // Optional: balance above = tight, below = danger (default 200)
  enableWarnings        Boolean  @default(true)
  warningThreshold      Float?   // Optional: show warnings when balance below this
  defaultPaymentMethod  String?  // Default payment method (Cash, Card, Transfer, etc.)
  defaultAccountId      String?  // Default account for new transactions
  totalSavings          Float    @default(0) // Total accumulated savings (kept for backwards compatibility)
  cardCollapseStates    String   @default("{}") // JSON object with card collapse states
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SavingsCategory {
  id            String   @id @default(cuid())
  userId        String
  name          String   // "Emergency Fund", "Vacation", etc.
  description   String   @default("")
  targetAmount  Float?   // Optional goal amount
  currentBalance Float   @default(0) // How much is saved in this category
  order         Int      @default(0) // For sorting
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model RateLimit {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([resetAt])
}
